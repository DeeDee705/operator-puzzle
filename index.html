<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Operator Puzzle</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<style>
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{overflow-x:hidden;background:#fff;-webkit-text-size-adjust:100%}
  :root{--vh:1vh}

  .wrap{min-height:calc(var(--vh)*100);width:100%;display:grid;place-items:center;padding:16px}
  .game{width:100%;max-width:640px;position:relative;margin:0 auto}

  #timer{position:absolute;top:0;left:0;background:#ff4444;color:#fff;font-weight:700;
    font-size:14px;border-radius:999px;padding:6px 10px;user-select:none}
  #gear{position:absolute;top:0;right:0;font-size:18px;opacity:.12;cursor:pointer;user-select:none;
    padding:6px;border-radius:999px;transition:opacity .2s}
  @media(hover:hover){#gear:hover{opacity:.8}}

  h1{margin:32px 0 0;text-align:center;color:#111;font-size:clamp(1.4rem,4.5vw,2.2rem);line-height:1.2}
  .sub{margin:8px 0 24px;text-align:center;color:#555;font-size:clamp(0.95rem,3.6vw,1.05rem)}
  #puzzleDisplay{text-align:center;color:#111;font-weight:800;font-size:clamp(1.8rem,7vw,2.6rem);margin:24px 0}

  #operatorsContainer{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(64px,1fr));
    gap:12px;max-width:360px;margin:0 auto 20px;justify-items:center}
  .op{width:64px;height:56px;display:grid;place-items:center;border:2px solid #1b1b1b;border-radius:10px;
    font-weight:800;font-size:1.5rem;color:#1b1b1b;background:#f6f6f6;user-select:none;cursor:pointer;
    transition:transform .1s,background .1s}
  .op.sel{background:#2eb150;color:#fff;border-color:#2eb150}
  @media(hover:hover){.op:not(.sel):hover{transform:scale(1.05);background:#e9f3ff}}

  #checkBtn{display:block;margin:20px auto 0;background:#2eb150;color:#fff;border:0;border-radius:10px;
    padding:14px 22px;font-size:clamp(1rem,3.8vw,1.1rem);font-weight:700;cursor:pointer}
  #checkBtn[disabled]{opacity:.5;cursor:not-allowed}
  #message{display:none;margin:16px auto 0;max-width:640px;padding:12px 14px;border-radius:10px;
    text-align:center;font-weight:700;font-size:clamp(0.95rem,3.6vw,1.05rem)}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;padding:16px;overflow:auto}
  .modal-inner{background:#fff;margin:auto;padding:18px;border-radius:12px;width:100%;max-width:420px}
  .modal-row{margin:12px 0}
  .close-x{font-size:26px;cursor:pointer;color:#888;user-select:none}

  /* password gate inside modal */
  #pwdGate{display:none}
  #configBody{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="game">
      <div id="timer">5:00</div>
      <div id="gear" title="Settings" onclick="showConfig()">⚙️</div>

      <h1>Can you find a way?</h1>
      <div class="sub">Change the operators to get the correct result!</div>

      <div id="puzzleDisplay">3 + 2 + 3 = 18</div>
      <div id="operatorsContainer"></div>
      <button id="checkBtn" onclick="checkAnswer()">Check Answer</button>
      <div id="message"></div>
    </div>
  </div>

  <!-- Settings Modal (password protected) -->
  <div id="configModal" class="modal" aria-hidden="true">
    <div class="modal-inner">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin:0">Game Settings</h3>
        <span class="close-x" onclick="closeConfig()">&times;</span>
      </div>

      <!-- Password gate -->
      <div id="pwdGate" class="modal-row">
        <label><strong>Password:</strong></label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="configPassword" type="password" placeholder="Enter password"
                 style="flex:1;padding:8px;border:1px solid #ccc;border-radius:8px" />
          <button onclick="verifyPassword()" style="padding:8px 12px;border:0;border-radius:8px;background:#2eb150;color:#fff;font-weight:700">
            Unlock
          </button>
        </div>
        <div id="pwdError" style="color:#c62828;font-size:.9rem;margin-top:6px;display:none">Incorrect password</div>
      </div>

      <!-- Body -->
      <div id="configBody">
        <div class="modal-row">
          <label><strong>Difficulty:</strong></label>
          <select id="difficultyLevel" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px">
            <option value="easy">Easy (3 numbers)</option>
            <option value="medium">Medium (4 numbers)</option>
            <option value="hard">Hard (5 numbers)</option>
          </select>
        </div>

        <div class="modal-row">
          <label><strong>Operators:</strong></label>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px">
            <label><input type="checkbox" id="allowAdd" checked> +</label>
            <label><input type="checkbox" id="allowSub" checked> −</label>
            <label><input type="checkbox" id="allowMul" checked> ×</label>
            <label><input type="checkbox" id="allowDiv"> ÷</label>
          </div>
        </div>

        <div class="modal-row">
          <label><strong>Victory message:</strong></label>
          <input id="victoryMessage" type="text"
                 value="Correct! You may pass to the next challenge!"
                 style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px" />
        </div>

        <div class="modal-row">
          <label><strong>Time limit (min):</strong></label>
          <input id="timeLimit" type="number" min="1" max="15" value="5"
                 style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px" />
        </div>

        <!-- Attempt limiter -->
        <div class="modal-row" style="padding:12px;border:1px solid #eee;border-radius:10px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="enableAttemptLimit" checked>
            <strong>Limit number of tries</strong>
          </label>
          <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
            <span>Max tries:</span>
            <input id="maxAttempts" type="number" min="1" max="10" value="3"
                   style="width:72px;padding:6px;border:1px solid #ccc;border-radius:8px;text-align:center" />
          </div>
        </div>

        <!-- Failure task -->
        <div class="modal-row" style="padding:12px;border:1px solid #eee;border-radius:10px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="enableFailureTask">
            <strong>Show custom task when failed</strong>
          </label>
          <textarea id="failureTaskText" rows="2" placeholder="e.g. You have failed, but can redeem yourselves by each doing 10 push-ups."
                    style="width:100%;margin-top:8px;padding:8px;border:1px solid #ccc;border-radius:8px;resize:vertical"></textarea>
        </div>

        <button onclick="saveConfig()"
                style="width:100%;margin-top:8px;padding:12px;border:0;border-radius:10px;background:#1976D2;color:#fff;font-weight:700">
          Save & New Puzzle
        </button>
      </div>
    </div>
  </div>

<script>
  /* viewport */
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH(); addEventListener('resize', setVH); addEventListener('orientationchange', setVH); addEventListener('load', ()=>setTimeout(setVH,50));

  /* config + state */
  let gameConfig = {
    password: "teacher123",
    difficulty: "easy",
    operators: ['+', '-', '×'],
    victoryMessage: "Correct! You may pass to the next challenge!",
    timeLimit: 5,               // minutes
    enableAttemptLimit: true,   // limiter ON by default
    maxAttempts: 3,             // default 3
    enableFailureTask: false,   // optional task OFF by default
    failureTaskText: ""         // task text (optional)
  };

  let currentPuzzle=null, timeRemaining=300, timerInterval=null, attemptsUsed=0, locked=false;

  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', init) : init();

  function init(){ generatePuzzle(); startTimer(); }

  function generatePuzzle(){
    attemptsUsed = 0; locked = false; setLocked(false);
    const d=gameConfig.difficulty; let nums,tgt, tries=0;
    do{
      tries++;
      if(d==='easy'){ nums=gen(3,2,5); tgt=rand(1,20); }
      else if(d==='medium'){ nums=gen(4,1,8); tgt=rand(1,50); }
      else { nums=gen(5,1,10); tgt=rand(1,100); }
      if(solvable(nums,tgt) || tries>=50) break;
    }while(true);
    if(tries>=50){ const r=makeSolvable(d); nums=r.numbers; tgt=r.target; }
    currentPuzzle={numbers:nums,target:tgt,operators:new Array(nums.length-1).fill('+')};
    drawEq(); drawOps();
    hideMsg();
  }

  const gen=(c,min,max)=>Array.from({length:c},()=>rand(min,max));
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function drawEq(){
    const d=document.getElementById('puzzleDisplay');
    const n=currentPuzzle.numbers, o=currentPuzzle.operators;
    let eq=''; for(let i=0;i<n.length;i++){ eq+=n[i]; if(i<n.length-1) eq+=` ${o[i]} `; }
    d.textContent = eq + ` = ${currentPuzzle.target}`;
  }

  function drawOps(){
    const c=document.getElementById('operatorsContainer'); c.innerHTML='';
    for(let i=0;i<currentPuzzle.operators.length;i++){
      const col=document.createElement('div'); col.style.display='grid'; col.style.gap='10px';
      gameConfig.operators.forEach(op=>{
        const b=document.createElement('button'); b.type='button';
        b.className='op' + (currentPuzzle.operators[i]===op?' sel':''); b.textContent=op;
        b.onclick=()=>{ if(locked) return; currentPuzzle.operators[i]=op; drawEq(); drawOps(); };
        col.appendChild(b);
      });
      c.appendChild(col);
    }
  }

  function checkAnswer(){
    if(locked) return;
    const r=calc(currentPuzzle.numbers,currentPuzzle.operators);
    const m=document.getElementById('message');

    if(r===currentPuzzle.target){
      m.textContent=gameConfig.victoryMessage;
      m.style.cssText='display:block;background:#d4edda;color:#155724;border:2px solid #2eb150;border-radius:10px;animation:pulse .6s ease-in-out';
      clearInterval(timerInterval);
      return;
    }

    // wrong attempt
    attemptsUsed++;
    if(gameConfig.enableAttemptLimit){
      const remaining = gameConfig.maxAttempts - attemptsUsed;
      if(remaining > 0){
        m.textContent = `Not quite. You got ${r ?? 'an invalid result'}, need ${currentPuzzle.target}. Attempt ${attemptsUsed} of ${gameConfig.maxAttempts}.`;
        m.style.cssText='display:block;background:#f8d7da;color:#721c24;border:2px solid #f44336;border-radius:10px;';
      }else{
        failOut('You\'ve used all tries!');
      }
    }else{
      m.textContent = `Not quite. You got ${r ?? 'an invalid result'}, need ${currentPuzzle.target}. Try again!`;
      m.style.cssText='display:block;background:#f8d7da;color:#721c24;border:2px solid #f44336;border-radius:10px;';
    }
  }

  function failOut(baseMsg){
    clearInterval(timerInterval);
    locked = true; setLocked(true);
    const m=document.getElementById('message');
    const extra = (gameConfig.enableFailureTask && gameConfig.failureTaskText.trim())
      ? ` ${gameConfig.failureTaskText.trim()}`
      : ' Game over!';
    m.textContent = `${baseMsg}${extra}`;
    m.style.cssText='display:block;background:#f8d7da;color:#721c24;border:2px solid #f44336;border-radius:10px;';
  }

  function calc(nums,ops){
    let r=nums[0];
    for(let i=0;i<ops.length;i++){
      const o=ops[i], n=nums[i+1];
      if(o==='+') r+=n; else if(o==='-') r-=n; else if(o==='×') r*=n;
      else if(o==='÷'){ if(n===0||r%n!==0) return null; r/=n; }
      if(r<-50||r>500||!Number.isInteger(r)) return null;
    }
    return r;
  }

  function solvable(nums,t){
    const ops=gameConfig.operators, p=nums.length-1, total=Math.pow(ops.length,p);
    for(let i=0;i<total;i++){
      const combo=[]; let x=i;
      for(let k=0;k<p;k++){ combo.push(ops[x%ops.length]); x=Math.floor(x/ops.length); }
      if(calc(nums,combo)===t) return true;
    }
    return false;
  }

  function makeSolvable(d){
    let tgt,nums;
    if(d==='easy'){ tgt=rand(1,20); nums=gen(3,2,5); }
    else if(d==='medium'){ tgt=rand(1,50); nums=gen(4,2,8); }
    else { tgt=rand(1,100); nums=gen(5,2,10); }
    const ops=gameConfig.operators; let cur=tgt;
    for(let i=nums.length-1;i>0;i--){
      const op=ops[Math.floor(Math.random()*ops.length)];
      if(op==='+') cur-=nums[i]; else if(op==='-') cur+=nums[i]; else if(op==='×'&&nums[i]!==0) cur=Math.round(cur/nums[i]);
    }
    nums[0]=Math.max(2,Math.min(10,Math.abs(cur)));
    return {numbers:nums,target:tgt};
  }

  /* timer */
  function startTimer(){
    timeRemaining=gameConfig.timeLimit*60; updTimer();
    clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
      timeRemaining--; updTimer();
      if(timeRemaining<=0){
        clearInterval(timerInterval);
        attemptsUsed++;
        if(gameConfig.enableAttemptLimit && attemptsUsed>=gameConfig.maxAttempts){
          failOut("Time's up! ");
        }else{
          // warn + allow continue (counts as an attempt)
          const m=document.getElementById('message');
          const remain = gameConfig.enableAttemptLimit ? (gameConfig.maxAttempts-attemptsUsed) : '∞';
          m.textContent = `Time's up! ${gameConfig.enableAttemptLimit ? `Attempt ${attemptsUsed} of ${gameConfig.maxAttempts}.` : ''}`;
          m.style.cssText='display:block;background:#f8d7da;color:#721c24;border:2px solid #f44336;border-radius:10px;';
        }
      }
    },1000);
  }
  function updTimer(){
    const m=Math.floor(timeRemaining/60), s=(timeRemaining%60).toString().padStart(2,'0');
    const el=document.getElementById('timer'); if(el) el.textContent=`${m}:${s}`;
  }

  function setLocked(state){
    document.getElementById('checkBtn').disabled = state;
    // buttons visually remain but click handlers check 'locked'
  }

  function hideMsg(){ const m=document.getElementById('message'); m.style.display='none'; m.textContent=''; }

  /* settings (password protected) */
  function showConfig(){
    document.getElementById('configModal').style.display='block';
    document.getElementById('pwdGate').style.display='block';
    document.getElementById('configBody').style.display='none';
    document.getElementById('configPassword').value='';
    document.getElementById('pwdError').style.display='none';
    document.body.style.overflow='hidden';
  }
  function closeConfig(){
    document.getElementById('configModal').style.display='none';
    document.body.style.overflow='auto';
  }
  function verifyPassword(){
    const ok = document.getElementById('configPassword').value === gameConfig.password;
    if(!ok){ document.getElementById('pwdError').style.display='block'; return; }
    // load current settings
    document.getElementById('difficultyLevel').value = gameConfig.difficulty;
    document.getElementById('allowAdd').checked = gameConfig.operators.includes('+');
    document.getElementById('allowSub').checked = gameConfig.operators.includes('-');
    document.getElementById('allowMul').checked = gameConfig.operators.includes('×');
    document.getElementById('allowDiv').checked = gameConfig.operators.includes('÷');
    document.getElementById('victoryMessage').value = gameConfig.victoryMessage;
    document.getElementById('timeLimit').value = gameConfig.timeLimit;
    document.getElementById('enableAttemptLimit').checked = gameConfig.enableAttemptLimit;
    document.getElementById('maxAttempts').value = gameConfig.maxAttempts;
    document.getElementById('enableFailureTask').checked = gameConfig.enableFailureTask;
    document.getElementById('failureTaskText').value = gameConfig.failureTaskText;

    document.getElementById('pwdGate').style.display='none';
    document.getElementById('configBody').style.display='block';
  }
  function saveConfig(){
    gameConfig.difficulty = document.getElementById('difficultyLevel').value;
    const ops=[]; if(document.getElementById('allowAdd').checked) ops.push('+');
    if(document.getElementById('allowSub').checked) ops.push('-');
    if(document.getElementById('allowMul').checked) ops.push('×');
    if(document.getElementById('allowDiv').checked) ops.push('÷');
    gameConfig.operators = ops.length?ops:['+'];

    gameConfig.victoryMessage = document.getElementById('victoryMessage').value;
    gameConfig.timeLimit = Math.max(1, parseInt(document.getElementById('timeLimit').value||'5',10));

    gameConfig.enableAttemptLimit = document.getElementById('enableAttemptLimit').checked;
    gameConfig.maxAttempts = Math.max(1, parseInt(document.getElementById('maxAttempts').value||'3',10));

    gameConfig.enableFailureTask = document.getElementById('enableFailureTask').checked;
    gameConfig.failureTaskText = document.getElementById('failureTaskText').value;

    closeConfig();
    clearInterval(timerInterval);
    generatePuzzle();
    startTimer();
  }

  // expose needed fns
  window.showConfig=showConfig;
  window.closeConfig=closeConfig;
  window.verifyPassword=verifyPassword;
  window.saveConfig=saveConfig;
  window.checkAnswer=checkAnswer;
</script>
</body>
</html>
